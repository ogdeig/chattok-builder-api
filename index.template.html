<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>{{TITLE}}</title>

  <!--
    IMPORTANT:
    When this HTML runs inside iframe srcdoc (about:srcdoc), relative paths can resolve
    to the parent app base (/) depending on how the preview runner is hosted.
    We force a local <base> using document.referrer (the parent page URL directory)
    so that style.css and game.js resolve correctly.
  -->
  <script>
    (function () {
      try {
        var ref = document.referrer;
        if (!ref && window.parent && window.parent.location) ref = window.parent.location.href;
        if (!ref) return;

        var u = new URL(ref);
        var dir = u.origin + u.pathname.replace(/[^\/]*$/, "");

        var base = document.createElement("base");
        base.href = dir;
        document.head.appendChild(base);
      } catch {}
    })();
  </script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div id="app">
    <div id="gameScreen" class="game-screen">
      <!-- CONNECT-FIRST overlay -->
      <div id="setupOverlay" class="overlay">
        <div class="overlay-card">
          <div class="title">{{TITLE}}</div>
          <div class="subtitle">{{ONE_SENTENCE}}</div>

          <div class="hint" style="margin-top:10px">
            <div class="hint-title">How to play</div>
            <div class="hint-sub">{{SUBTITLE}}</div>
            <ul class="hint-list">
              {{HOW_TO_PLAY_LI}}
            </ul>
            <div class="hint-sub muted">
              Tip: Once connected, chat/likes/gifts will instantly affect the action on screen.
            </div>
          </div>

          <div class="form-grid" style="margin-top:12px">
            <label class="field">
              <span class="field-label">TikTok LIVE ID</span>
              <input id="liveIdInput" type="text" placeholder="Example: huntbreaks" autocomplete="off" />
            </label>

            <!-- Injected by server (Round seconds + Win goal) -->
            {{SETTINGS_FIELDS_HTML}}

            <button id="startGameBtn" class="primary-btn" type="button">
              Start & Connect
            </button>

            <div class="status-line">
              <span id="statusText">Enter your LIVE ID, then press Start.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main game UI -->
      <div class="game-wrapper">
        <div class="topbar">
          <div>
            <div class="game-name">{{TITLE}}</div>
            <div class="game-sub">{{SUBTITLE}}</div>
          </div>

          <div class="pill">
            <span class="status-text" id="statusTextInGame">Ready</span>
          </div>
        </div>

        <div class="layout">
          <div class="main">
            <div class="viewport">
              <div class="safe-top"></div>

              <!-- game.js renders here -->
              <div id="gameRoot" class="game-root"></div>

              <div class="safe-bottom"></div>
            </div>
          </div>

          <!-- Flags (pop-out toasts). No scroll boxes. Transparent + small. -->
          <div class="side">
            <div class="side-card">
              <div id="flags" class="flags"></div>
            </div>
          </div>
        </div>

        <div class="footer-text">
          Powered by ChatTok • Live interactions drive the action
        </div>
      </div>
    </div>
  </div>

  <!--
    TikTok client stack

    CRITICAL:
    - TikTokClient expects a global "proto" object for Protobuf deserialization.
    - In ChatTokGaming preview/runtime, these shared libs should be served from site root.
    - So on chattokgaming.com we load:
        /proto.bundle.js
        /tiktok-client.js
      (NOT relative ./proto.bundle.js which can 404 inside the preview runner directory)
  -->
  <script>
    (function () {
      function $(id){ return document.getElementById(id); }
      function setStatus(msg){
        try{
          var s1 = $("statusText");
          var s2 = $("statusTextInGame");
          if (s1) s1.textContent = msg;
          if (s2) s2.textContent = msg;
        } catch {}
      }

      function loadScript(src){
        return new Promise(function(resolve, reject){
          var s = document.createElement("script");
          s.src = src;
          s.async = false;
          s.onload = function(){ resolve(true); };
          s.onerror = function(){ reject(new Error("Failed to load: " + src)); };
          document.body.appendChild(s);
        });
      }

      var host = (location && location.hostname ? String(location.hostname) : "");
      var isChatTok = /(^|\.)chattokgaming\.com$/i.test(host);

      // On ChatTokGaming: use absolute root paths (fixes proto.bundle.js 404 in preview).
      var protoSrc  = isChatTok ? "/proto.bundle.js" : "proto.bundle.js";
      var clientSrc = isChatTok ? "/tiktok-client.js" : "tiktok-client.js";

      async function boot(){
        setStatus("Loading connection libraries…");

        await loadScript(protoSrc);
        if (typeof window.proto === "undefined" || !window.proto){
          throw new Error("proto loaded, but window.proto is not defined.");
        }

        await loadScript(clientSrc);
        if (typeof window.TikTokClient === "undefined"){
          throw new Error("TikTokClient is not available after loading " + clientSrc);
        }

        await loadScript("game.js");
        setStatus("Ready");
      }

      boot().catch(function(err){
        console.error(err);
        setStatus("Missing connection libs (proto/TikTokClient).");

        // Friendly on-screen hint (no blocking popups)
        try{
          var root = $("gameRoot");
          if (root){
            var d = document.createElement("div");
            d.className = "card";
            d.style.margin = "12px";
            d.innerHTML =
              "<h3>Connection library missing</h3>" +
              "<p>This game expects ChatTokGaming to provide <b>/proto.bundle.js</b> and <b>/tiktok-client.js</b>.</p>" +
              "<p class='muted'>If you’re previewing outside ChatTokGaming, these files won’t exist.</p>";
            root.appendChild(d);
          }
        } catch {}
      });
    })();
  </script>
</body>
</html>
