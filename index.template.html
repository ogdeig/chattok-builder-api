<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>{{TITLE}}</title>

  <!--
    IMPORTANT:
    When this HTML runs inside iframe srcdoc (about:srcdoc), relative paths can resolve
    to site root (/) due to parent app base href="/".
    We force a local <base> using document.referrer (the parent page URL).
  -->
  <script>
    (function () {
      try {
        var ref = document.referrer;
        if (!ref && window.parent && window.parent.location) ref = window.parent.location.href;
        if (!ref) return;

        var u = new URL(ref);
        var dir = u.origin + u.pathname.replace(/[^\/]*$/, "");

        var base = document.createElement("base");
        base.href = dir;
        document.head.appendChild(base);
      } catch {}
    })();
  </script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div id="app">
    <div id="gameScreen" class="game-screen">
      <!-- CONNECT-FIRST overlay -->
      <div id="setupOverlay" class="overlay">
        <div class="overlay-card">
          <div class="title">{{TITLE}}</div>
          <div class="subtitle">{{ONE_SENTENCE}}</div>

          <div class="hint" style="margin-top:10px">
            <div class="hint-title">How to play</div>
            <div class="hint-sub">{{SUBTITLE}}</div>
            <ul class="hint-list">
              {{HOW_TO_PLAY_LI}}
            </ul>
            <div class="hint-sub muted">
              Tip: Once connected, chat/likes/gifts will instantly affect the action on screen.
            </div>
          </div>

          <div class="form-grid" style="margin-top:12px">
            <label class="field">
              <span class="field-label">TikTok LIVE ID</span>
              <input id="liveIdInput" type="text" placeholder="Example: huntbreaks" autocomplete="off" />
            </label>

            <!-- Injected by server (Round seconds + Win goal) -->
            {{SETTINGS_FIELDS_HTML}}

            <button id="startGameBtn" class="primary-btn" type="button">
              Start & Connect
            </button>

            <div class="status-line">
              <span id="statusText">Enter your LIVE ID, then press Start.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Main game UI -->
      <div class="game-wrapper">
        <div class="topbar">
          <div>
            <div class="game-name">{{TITLE}}</div>
            <div class="game-sub">{{SUBTITLE}}</div>
          </div>

          <div class="pill">
            <span class="status-text" id="statusTextInGame">Ready</span>
          </div>
        </div>

        <div class="layout">
          <div class="main">
            <div class="viewport">
              <div class="safe-top"></div>

              <!-- game.js renders here -->
              <div id="gameRoot" class="game-root"></div>

              <div class="safe-bottom"></div>
            </div>
          </div>

          <!-- Flags (pop-out toasts). No scroll boxes. Transparent + small. -->
          <div class="side">
            <div class="side-card">
              <div id="flags" class="flags"></div>
            </div>
          </div>
        </div>

        <div class="footer-text">
          Powered by ChatTok • Live interactions drive the action
        </div>
      </div>
    </div>
  </div>

  <!--
    PROTO + TIKTOK STACK LOADER
    Fixes: proto.bundle.js 404 + "proto is not defined"
    Strategy:
      - If window.proto already exists (host injected), do nothing.
      - Else try multiple candidate URLs for proto.bundle.js.
      - Only load tiktok-client.js AFTER proto exists.
      - Only load game.js AFTER TikTokClient exists.
  -->
  <script>
    (function () {
      const statusText = document.getElementById("statusText");
      const statusTextInGame = document.getElementById("statusTextInGame");

      function setStatus(msg) {
        try { if (statusText) statusText.textContent = msg; } catch {}
        try { if (statusTextInGame) statusTextInGame.textContent = msg; } catch {}
      }

      // Simple script loader
      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = url;
          s.async = true;
          s.onload = () => resolve(url);
          s.onerror = () => reject(new Error("Failed to load: " + url));
          document.head.appendChild(s);
        });
      }

      function uniq(list) {
        const out = [];
        const seen = new Set();
        for (const x of list) {
          const v = (x || "").trim();
          if (!v) continue;
          if (seen.has(v)) continue;
          seen.add(v);
          out.push(v);
        }
        return out;
      }

      function originFromRef() {
        try {
          const ref = document.referrer || location.href;
          const u = new URL(ref);
          return u.origin;
        } catch {
          return "";
        }
      }

      async function loadFirstWorking(candidates, isReady) {
        const tries = uniq(candidates);
        const errors = [];
        for (const url of tries) {
          try {
            await loadScript(url + (url.includes("?") ? "&" : "?") + "v=" + Date.now());
            if (!isReady || isReady()) return { ok: true, url };
            errors.push("Loaded but not ready: " + url);
          } catch (e) {
            errors.push(String(e && e.message ? e.message : e));
          }
        }
        return { ok: false, errors, tried: tries };
      }

      // Candidates for proto.bundle.js (covers common host + game-folder layouts)
      const O = originFromRef();
      const protoCandidates = [
        "proto.bundle.js",
        "assets/proto.bundle.js",
        "reference/proto.bundle.js",

        "/proto.bundle.js",
        "/assets/proto.bundle.js",
        "/reference/proto.bundle.js",

        O ? (O + "/proto.bundle.js") : "",
        O ? (O + "/assets/proto.bundle.js") : "",
        O ? (O + "/reference/proto.bundle.js") : ""
      ];

      const tiktokCandidates = [
        "tiktok-client.js",
        "assets/tiktok-client.js",
        "reference/tiktok-client.js",

        "/tiktok-client.js",
        "/assets/tiktok-client.js",
        "/reference/tiktok-client.js",

        O ? (O + "/tiktok-client.js") : "",
        O ? (O + "/assets/tiktok-client.js") : "",
        O ? (O + "/reference/tiktok-client.js") : ""
      ];

      async function boot() {
        try {
          // 1) proto
          if (typeof window.proto === "undefined") {
            setStatus("Loading TikTok protocol…");
            const protoRes = await loadFirstWorking(
              protoCandidates,
              () => typeof window.proto !== "undefined"
            );

            if (!protoRes.ok) {
              console.error("Proto load failed:", protoRes);
              setStatus("ERROR: proto.bundle.js not found in preview. Contact support or update host script path.");
              return; // stop: prevents 'proto is not defined' crashes
            }
          }

          // 2) TikTokClient
          if (typeof window.TikTokClient === "undefined") {
            setStatus("Loading TikTok client…");
            const ttRes = await loadFirstWorking(
              tiktokCandidates,
              () => typeof window.TikTokClient !== "undefined"
            );

            if (!ttRes.ok) {
              console.error("tiktok-client load failed:", ttRes);
              setStatus("ERROR: tiktok-client.js not found in preview.");
              return;
            }
          }

          // 3) game.js (always local to the game folder)
          setStatus("Starting game…");
          await loadScript("game.js" + "?v=" + Date.now());
          setStatus("Ready");
        } catch (e) {
          console.error("Boot error:", e);
          setStatus("ERROR: Failed to boot game scripts.");
        }
      }

      boot();
    })();
  </script>
</body>
</html>
