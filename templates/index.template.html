<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>{{TITLE}}</title>

  <!--
    CRITICAL: iframe/srcdoc + SPA base-href fix
    Some hosts set <base href="/"> which makes "style.css" resolve to "/style.css" (404).
    We compute a safe base href from document.referrer (preferred) and inject it BEFORE any relative URLs.
  -->
  <script>
    (function () {
      try {
        // In srcdoc iframes, document.referrer is usually the parent page URL.
        var ref = document.referrer;

        // Fallback: try parent.location if allowed (may throw in cross-origin/sandbox).
        if (!ref) {
          try {
            if (window.parent && window.parent.location && window.parent.location.href) {
              ref = window.parent.location.href;
            }
          } catch (e) { /* ignore */ }
        }

        // If we still don't have a usable ref, do nothing (local hosting will still work).
        if (!ref) return;

        // Compute directory of the referrer URL.
        var u = new URL(ref);
        var dir = u.origin + u.pathname.replace(/[^\/]*$/, "");
        if (!dir.endsWith("/")) dir += "/";

        var base = document.createElement("base");
        base.href = dir;

        // Insert base as FIRST element in <head> to affect subsequent relative loads.
        var head = document.head || document.getElementsByTagName("head")[0];
        head.insertBefore(base, head.firstChild);
      } catch (e) {
        // Never break the page if base calculation fails.
      }
    })();
  </script>

  <!-- IMPORTANT: relative to computed <base> above -->
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div id="app">

    <!-- ===============================
         START / SETUP OVERLAY
         =============================== -->
    <div id="setupOverlay" class="overlay">
      <div class="overlay-card">
        <h1 class="title">{{TITLE}}</h1>
        <p class="subtitle">{{SUBTITLE}}</p>

        <div class="form-grid" id="setupFields">

          <label class="field field-span">
            <span class="field-label">TikTok LIVE ID (username only)</span>
            <input
              id="liveIdInput"
              type="text"
              placeholder="username (without @)"
              autocomplete="off"
              autocapitalize="none"
              spellcheck="false"
            />
          </label>

          <!-- Server injects additional settings fields here (NO duplicate LIVE ID field). -->
          {{SETTINGS_FIELDS_HTML}}

        </div>

        <button id="startGameBtn" class="primary-btn">Connect &amp; Start Game</button>

        <p id="statusText" class="status-line">Waiting for platform scripts…</p>

        <div class="hint">
          <div class="hint-title">How to play</div>
          <div class="hint-sub">{{ONE_SENTENCE}}</div>
          <ul class="hint-list">{{HOW_TO_PLAY_LI}}</ul>
          <div class="hint-sub muted">
            Tip: if connection fails, check your LIVE ID and token injection, then retry.
          </div>
        </div>

        <!-- Platform checks (proto + tiktok-client.js are platform-provided) -->
        <div class="platform-checks" aria-live="polite">
          <div class="check-row">
            <span class="check-icon" id="checkTikTokIcon">⏳</span>
            <span class="check-text">
              TikTok client
              <span class="check-detail" id="checkTikTokText">Waiting for injection…</span>
            </span>
          </div>
          <div class="check-row">
            <span class="check-icon" id="checkProtoIcon">⏳</span>
            <span class="check-text">
              proto
              <span class="check-detail" id="checkProtoText">Waiting for injection…</span>
            </span>
          </div>
        </div>

        <div class="hint-sub muted" style="margin-top:10px;">
          This game does <b>not</b> ship platform scripts. ChatTokGaming preview/live injects them.
          If you are testing locally, you may see “Waiting for injection.”
        </div>
      </div>
    </div>

    <!-- ===============================
         GAME SCREEN (9:16 VIEWPORT)
         =============================== -->
    <div id="gameScreen" class="game-screen">
      <div class="game-wrapper">

        <header class="topbar">
          <div class="topbar-left">
            <div class="game-name">{{TITLE}}</div>
            <div class="game-sub">{{SUBTITLE}}</div>
          </div>
          <div class="topbar-right">
            <span class="pill">Status: <span id="statusTextInGame" class="status-text">Disconnected</span></span>
          </div>
        </header>

        <main class="layout">
          <section class="main">
            <div class="viewport">
              <div class="safe-top"></div>
              <div id="gameRoot" class="game-root">
                <!-- game.js renders here -->
              </div>
              <div class="safe-bottom"></div>
            </div>
          </section>

          <!-- Notifications area (game.js may or may not use this depending on the plan/spec) -->
          <aside class="side">
            <div class="side-card">
              <div class="side-title">Notifications</div>
              <div id="flags" class="flags"></div>
              <div class="side-foot">Chat / likes / gifts can appear here (if used by this game).</div>
            </div>
          </aside>
        </main>

        <footer class="footer-text">
          Connection: <span id="statusTextFooter" class="status-text">Disconnected</span>
        </footer>
      </div>
    </div>

  </div>

  <!--
    PROTO CONTRACT + TIKTOK CLIENT CONTRACT
    ✅ Do NOT load proto.bundle.js / protobuf scripts here.
    ✅ Do NOT load tiktok-client.js here.
    ChatTokGaming preview/live injects these platform scripts.
    This template only loads game.js (your game logic) and checks for injection.
  -->
  <script>
    (function () {
      function setCheck(idIcon, idText, ok, msg) {
        var icon = document.getElementById(idIcon);
        var text = document.getElementById(idText);
        if (!icon || !text) return;
        icon.textContent = ok ? "✅" : "❌";
        text.textContent = msg;
      }

      function updateChecks() {
        var hasTikTokClient = (typeof TikTokClient !== "undefined");
        var hasProto = (typeof proto !== "undefined") || (typeof window !== "undefined" && typeof window.proto !== "undefined");

        if (hasTikTokClient) {
          setCheck("checkTikTokIcon", "checkTikTokText", true, "Injected");
        } else {
          setCheck("checkTikTokIcon", "checkTikTokText", false, "Missing (platform must inject tiktok-client.js)");
        }

        if (hasProto) {
          setCheck("checkProtoIcon", "checkProtoText", true, "Injected");
        } else {
          setCheck("checkProtoIcon", "checkProtoText", false, "Missing (platform must inject proto bundle)");
        }

        // Friendly status line on overlay
        var st = document.getElementById("statusText");
        if (st) {
          if (!hasTikTokClient && !hasProto) st.textContent = "Waiting for platform scripts…";
          else if (!hasTikTokClient) st.textContent = "TikTok client missing (platform injection required).";
          else if (!hasProto) st.textContent = "proto missing (platform injection required).";
          else st.textContent = "Ready. Enter LIVE ID and press Connect.";
        }
      }

      updateChecks();
      // Re-check a few times during boot (platform may inject after initial paint).
      var tries = 0;
      var t = setInterval(function () {
        tries++;
        updateChecks();
        var okTikTok = (typeof TikTokClient !== "undefined");
        var okProto = (typeof proto !== "undefined") || (typeof window !== "undefined" && typeof window.proto !== "undefined");
        if ((okTikTok && okProto) || tries >= 20) clearInterval(t);
      }, 350);
    })();
  </script>

  <!-- IMPORTANT: only load the game logic (paths fixed by <base> script above) -->
  <script defer src="./game.js"></script>
</body>
</html>
