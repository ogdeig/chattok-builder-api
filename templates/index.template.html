<!-- index.template.html — ChatTok Game Template (index.html output)
     ==============================================================
     FIXES INCLUDED:
     ✅ Stops style.css/game.js resolving to /style.css and /game.js
     ✅ Stronger base-resolution for iframe/srcdoc runners
     ✅ Does NOT request proto.bundle.js (prevents proto.bundle.js 404)
     ✅ Never references `proto` directly (prevents "proto is not defined")
     ✅ Does NOT load tiktok-client.js (platform provides it)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>{{TITLE}}</title>

  <!--
    Preview-safe BASE resolution:
    Many hosts run games in iframe/srcdoc, and relative URLs may resolve to site root.
    We set <base> to the best-known "game folder" URL.

    Priority:
    1) platform-injected globals (if they exist): CHATTOK_ASSET_BASE / CHATTOK_GAME_BASE / GAME_ASSET_BASE
    2) document.referrer (best for srcdoc)
    3) parent location (safe try/catch)
    4) location.href fallback
  -->
  <script>
    (function () {
      function tryParentHref() {
        try {
          if (window.parent && window.parent !== window && window.parent.location) {
            return String(window.parent.location.href || "");
          }
        } catch (e) {}
        return "";
      }

      function normalizeDir(href) {
        try {
          var u = new URL(href);
          return u.origin + u.pathname.replace(/[^\/]*$/, "");
        } catch (e) {
          return "";
        }
      }

      try {
        // 1) Prefer platform-injected base if present (no assumptions about name)
        var injected =
          (typeof window.CHATTOK_ASSET_BASE !== "undefined" && window.CHATTOK_ASSET_BASE) ? String(window.CHATTOK_ASSET_BASE) :
          (typeof window.CHATTOK_GAME_BASE !== "undefined" && window.CHATTOK_GAME_BASE) ? String(window.CHATTOK_GAME_BASE) :
          (typeof window.GAME_ASSET_BASE !== "undefined" && window.GAME_ASSET_BASE) ? String(window.GAME_ASSET_BASE) :
          "";

        var ref = String(document.referrer || "");
        var parentHref = tryParentHref();
        var selfHref = String(location.href || "");

        // If injected already looks like a directory URL, use it as-is. Otherwise normalize.
        var baseHref = injected ? (injected.endsWith("/") ? injected : normalizeDir(injected)) : "";
        if (!baseHref) baseHref = normalizeDir(ref) || normalizeDir(parentHref) || normalizeDir(selfHref);

        if (!baseHref) return;

        var base = document.createElement("base");
        base.href = baseHref;
        document.head.insertBefore(base, document.head.firstChild);
      } catch (e) {
        // no-op
      }
    })();
  </script>

  <!-- IMPORTANT: use ./ so it never becomes /style.css due to host base rules -->
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div id="app">

    <!-- ===============================
         START / SETUP OVERLAY
         =============================== -->
    <div id="setupOverlay" class="overlay">
      <div class="overlay-inner">

        <div class="brand">
          <div class="brandTitle">{{TITLE}}</div>
          <div class="brandSub">{{SUBTITLE}}</div>
        </div>

        <div class="panel">
          <div class="panelTitle">Connect</div>

          <label class="lbl">TikTok LIVE ID</label>
          <input id="liveIdInput" type="text" placeholder="Example: huntbreaks" autocomplete="off" />

          <!-- Settings fields live inside this container (required id) -->
          <div id="setupFields" class="settings">
            <div class="settingsTitle">Host Settings</div>

            <!-- Commands are ALWAYS variables (host-configurable) -->
            <div class="row2">
              <div>
                <label class="lbl">Join Command</label>
                <input id="joinCommandInput" type="text" placeholder="join" autocomplete="off" />
                <div class="miniHelp">Viewers can type this in chat to spawn/join.</div>
              </div>
              <div>
                <label class="lbl">Action Command</label>
                <input id="actionCommandInput" type="text" placeholder="attack" autocomplete="off" />
                <div class="miniHelp">Viewers can type this to trigger the main action.</div>
              </div>
            </div>

            <!-- Share fallback selector -->
            <div class="row2">
              <div class="toggle">
                <input id="shareAsJoinToggle" type="checkbox" />
                <label for="shareAsJoinToggle">Allow Shares to also count as Join</label>
              </div>

              <div class="toggle">
                <input id="shareAsActionToggle" type="checkbox" />
                <label for="shareAsActionToggle">Allow Shares to also count as Action</label>
              </div>
            </div>

            <div class="adv">
              <div class="advTitle">Advanced</div>

              <div class="row2">
                <div>
                  <label class="lbl">Round Seconds</label>
                  <input id="roundSecondsInput" type="text" placeholder="120" autocomplete="off" />
                  <div class="miniHelp">How long one round lasts.</div>
                </div>
                <div>
                  <label class="lbl">Win Goal</label>
                  <input id="winGoalInput" type="text" placeholder="25" autocomplete="off" />
                  <div class="miniHelp">Points / hits needed to win.</div>
                </div>
              </div>

              <div class="row2">
                <div class="toggle">
                  <input id="enableSfxToggle" type="checkbox" checked />
                  <label for="enableSfxToggle">Enable SFX</label>
                </div>
                <div class="toggle">
                  <input id="enableTtsToggle" type="checkbox" />
                  <label for="enableTtsToggle">Enable TTS (if game supports it)</label>
                </div>
              </div>

              <div class="miniHelp muted">
                Tip: If some viewers can’t be seen chatting, turn on Shares as Join/Action.
              </div>
            </div>
          </div>

          <button id="startGameBtn" class="primary-btn">Connect &amp; Start Game</button>

          <p id="statusText" class="status-line">Not connected</p>

          <!-- Preview environment diagnostics: NO URLs, no dev logs -->
          <div id="envHint" class="envHint" aria-live="polite"></div>

          <div class="hint">
            <div class="hint-title">How to play</div>
            <div class="hint-sub">{{ONE_SENTENCE}}</div>
            <ul class="hint-list" id="howToPlayList"></ul>
          </div>
        </div>

      </div>
    </div>

    <!-- ===============================
         GAME SCREEN (9:16 VIEWPORT)
         =============================== -->
    <div id="gameScreen" class="game-screen" aria-hidden="true">
      <div class="game-wrapper">
        <header class="topbar">
          <div class="topbar-left">
            <div class="game-name">{{TITLE}}</div>
            <div class="game-sub">{{SUBTITLE}}</div>
          </div>

          <div class="topbar-right">
            <div class="pill">
              <div class="pill-k">STATUS</div>
              <div class="pill-v" id="statusTextInGame">Disconnected</div>
            </div>

            <div class="pill">
              <div class="pill-k">ROUND</div>
              <div class="pill-v" id="roundLabel">1</div>
            </div>

            <div class="pill">
              <div class="pill-k">HYPE</div>
              <div class="pill-v" id="hypeLabel">0%</div>
            </div>
          </div>
        </header>

        <main id="gameRoot" class="stage" role="application" aria-label="Game Stage"></main>

        <!-- Optional containers: styled by CSS; behavior decided by game.js/spec -->
        <div id="flags" class="flags" aria-live="polite" aria-label="Live Notifications"></div>
        <div id="centerBanner" class="centerBanner hide"></div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      try {
        var list = document.getElementById("howToPlayList");
        if (!list) return;

        var items = {{HOW_TO_PLAY_JSON}};
        if (!Array.isArray(items)) items = [];
        if (!items.length) items = ["Type the Join command to spawn in.", "Use chat / likes / gifts to power up the action."];

        list.innerHTML = "";
        for (var i = 0; i < items.length; i++) {
          var li = document.createElement("li");
          li.textContent = String(items[i] || "");
          list.appendChild(li);
        }
      } catch (e) {}
    })();
  </script>

  <script>
    (function () {
      function setHint(msg) {
        try {
          var el = document.getElementById("envHint");
          if (!el) return;
          el.textContent = msg || "";
        } catch (e) {}
      }

      function checkEnv() {
        var hasTikTokClient = (typeof window.TikTokClient !== "undefined");
        var hasProto = (typeof window.proto !== "undefined");

        if (hasTikTokClient && hasProto) {
          setHint("Platform ready. You can connect now.");
          return;
        }

        if (!hasTikTokClient && !hasProto) {
          setHint("Waiting for platform scripts (TikTok client + proto). This is normal in ChatTokGaming preview/live.");
        } else if (!hasTikTokClient) {
          setHint("Waiting for platform TikTok client. If running locally, this must be provided by the host.");
        } else if (!hasProto) {
          setHint("Waiting for platform proto bundle. If this persists, the host environment must inject proto.");
        }
      }

      checkEnv();
      var tries = 0;
      var t = setInterval(function () {
        tries++;
        checkEnv();
        if (tries >= 20) clearInterval(t);
      }, 150);
    })();
  </script>

  <!-- IMPORTANT: use ./ so it never becomes /game.js due to host base rules -->
  <script src="./game.js" defer></script>
</body>
</html>
