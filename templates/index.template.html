<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>{{TITLE}}</title>

  <!--
    IMPORTANT (ChatTokGaming preview runner):
    In iframe/srcdoc or SPA hosts, relative paths like "style.css" can incorrectly resolve to "/style.css" (site root),
    causing 404s. We set a safe <base> derived from document.referrer (parent page URL) before loading CSS/JS.
  -->
  <script>
    (function () {
      try {
        // If a base tag already exists, respect it.
        if (document.querySelector("base")) return;

        // Prefer referrer (best for srcdoc). Fallback to parent location if same-origin.
        var ref = document.referrer || "";
        if (!ref && window.parent && window.parent.location) {
          try { ref = window.parent.location.href || ""; } catch (e) {}
        }
        if (!ref) return;

        var u = new URL(ref);
        // Directory of the parent page URL
        var dir = u.origin + u.pathname.replace(/[^\/]*$/, "");

        // Insert base before any relative links/scripts parse
        var base = document.createElement("base");
        base.href = dir;
        document.head.appendChild(base);
      } catch (e) {
        // If anything fails, we simply don't set base.
      }
    })();
  </script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div id="app">

    <!-- ===============================
         SETUP / START OVERLAY
         =============================== -->
    <div id="setupOverlay" class="overlay">
      <div class="overlay-card">
        <header class="overlay-head">
          <h1 class="title">{{TITLE}}</h1>
          <div class="subtitle">{{SUBTITLE}}</div>
          <p class="oneSentence">{{ONE_SENTENCE}}</p>
        </header>

        <section class="overlay-section">
          <div class="fieldRow">
            <label class="field field-span">
              <span class="field-label">TikTok LIVE ID (username only)</span>
              <input id="liveIdInput" type="text" placeholder="username (without @)" autocomplete="off" />
            </label>
          </div>

          <div class="settingsGrid" id="settingsGrid">
            {{SETTINGS_FIELDS_HTML}}
          </div>

          <div class="btnRow">
            <button id="startGameBtn" class="primaryBtn" type="button">Connect &amp; Start Game</button>
          </div>

          <div class="statusLine">
            <span class="statusLabel">Status:</span>
            <span id="statusText" class="statusText">Waiting for platform scripts…</span>
          </div>

          <div class="tip">
            Tip: If connection fails, verify LIVE ID and ensure ChatTokGaming injected your token and platform scripts.
          </div>

          <div class="checks">
            <div class="checksTitle">Platform checks</div>
            <div class="checkItem">
              <span id="checkTikTokClientIcon" class="x">✖</span>
              <span class="checkText">TikTok client <span id="checkTikTokClientText">Checking…</span></span>
            </div>
            <div class="checkItem">
              <span id="checkProtoIcon" class="x">✖</span>
              <span class="checkText">proto <span id="checkProtoText">Checking…</span></span>
            </div>
            <div class="checksNote">
              This game does <b>not</b> ship platform scripts (no tiktok-client.js / no proto bundle).
              ChatTokGaming preview/live injects them.
            </div>
          </div>
        </section>

        <section class="overlay-section howto">
          <div class="howtoTitle">How to play</div>
          <ul class="howtoList">
            {{HOW_TO_PLAY_LI}}
          </ul>
        </section>
      </div>
    </div>

    <!-- ===============================
         GAME ROOT (9:16)
         =============================== -->
    <div id="gameRoot" class="gameRoot" aria-hidden="false">
      <div class="gameFrame">
        <canvas id="gameCanvas" width="720" height="1280"></canvas>

        <!-- HUD -->
        <div id="hud" class="hud">
          <div class="hudLeft">
            <div class="hudTitle">{{TITLE}}</div>
            <div class="hudSub">{{SUBTITLE}}</div>
          </div>
          <div class="hudRight">
            <div class="hudStat"><span class="k">Connection</span> <span id="statusTextInGame" class="v">Disconnected</span></div>
            <div class="hudStat"><span class="k">Live Events</span> <span class="v">Chat / likes / gifts</span></div>
          </div>
        </div>

        <!-- Flags / notifications -->
        <div id="flags" class="flags" aria-live="polite" aria-atomic="false"></div>

        <!-- Center callouts -->
        <div id="centerToast" class="centerToast" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- IMPORTANT:
       - Do NOT load tiktok-client.js here (ChatTokGaming injects it).
       - Do NOT load proto.bundle.js here (avoid 404s). We only verify presence and show status.
  -->
  <script>
    (function () {
      function setCheck(idIcon, idText, ok, text) {
        var icon = document.getElementById(idIcon);
        var label = document.getElementById(idText);
        if (!icon || !label) return;

        icon.className = ok ? "ok" : "x";
        icon.textContent = ok ? "✔" : "✖";
        label.textContent = text;
      }

      function runChecks() {
        var hasClient = (typeof window.TikTokClient !== "undefined");
        var hasProto = (typeof window.proto !== "undefined");

        setCheck(
          "checkTikTokClientIcon",
          "checkTikTokClientText",
          hasClient,
          hasClient ? "OK (injected)" : "Missing (platform must inject tiktok-client.js)"
        );

        setCheck(
          "checkProtoIcon",
          "checkProtoText",
          hasProto,
          hasProto ? "OK (injected)" : "Missing (platform must inject proto bundle)"
        );

        // Only update the status line if the game hasn't taken over statusText yet.
        var st = document.getElementById("statusText");
        if (st && (st.textContent || "").toLowerCase().includes("waiting")) {
          if (hasClient && hasProto) st.textContent = "Ready. Enter LIVE ID and press Connect & Start Game.";
          else st.textContent = "Waiting for injection… (works in ChatTokGaming preview/live)";
        }
      }

      // Check a couple times—some hosts inject scripts after first paint.
      runChecks();
      setTimeout(runChecks, 1200);
      setTimeout(runChecks, 3500);
    })();
  </script>

  <!-- Your game logic -->
  <script src="game.js"></script>
</body>
</html>
